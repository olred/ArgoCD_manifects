apiVersion: v1
kind: Service
metadata:
  name: victoria-service
spec:
  selector:
    app: victoria
  ports:
    - protocol: TCP
      port: 8428
      targetPort: 8428

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: victoria-config

data:
  vmconfig.yml: |
    scrape_configs:
    - job_name: vmdb
      static_configs:
        - targets: [ "localhost:8428" ]
    - job_name: k8s-apiservers
      kubernetes_sd_configs:
        - role: endpoints
          namespaces: 
            names:
              - dev
      relabel_configs:
        - action: keep
          source_labels:
          [
            __meta_kubernetes_namespace,
            __meta_kubernetes_service_name,
            __meta_kubernetes_endpoint_port_name
          ] 
          regex: dev
          



---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: victoria-deployment
  labels:
    app: victoria
spec:
  replicas: 1
  selector:
    matchLabels:
      app: victoria
  template:
    metadata:
      labels:
        app: victoria
    spec:
      securityContext:
        supplementalGroups:
          - 0
      containers:
        - name: victoria
          image: victoriametrics/victoria-metrics:stable
          ports:
            - containerPort: 8428
          command: ["--promscrape.config=/victoria-metrics-test/vmconfig.yml"]
          volumeMounts:
            - name: victoria-config
              mountPath: /victoria-metrics-test/
      volumes:
        - name: victoria-config
          configMap:
            name: victoria-config

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: victoria-ingress
spec:
  ingressClassName: traefik
  rules:
    - host: "victoria.olred.local"
      http:
        paths:
          - pathType: Prefix
            path: "/"
            backend:
              service:
                name: victoria-service
                port:
                  number: 8428